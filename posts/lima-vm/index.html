<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Paweł Weselak"><meta name=description content="Blog of Paweł Weselak pragmatyczne programowanie"><meta name=keywords content="Paweł Weselak,personal blog,senior java developer,senior software engineer"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://s.gravatar.com/avatar/98bbac18a8c6ff78732516b70a357c58?s=80"><meta name=twitter:title content="Lima quick-start"><meta name=twitter:description content="When you need Docker Desktop alternative"><meta property="og:title" content="Lima quick-start"><meta property="og:description" content="When you need Docker Desktop alternative"><meta property="og:type" content="article"><meta property="og:url" content="https://pawelweselak.com/posts/lima-vm/"><meta property="og:image" content="https://s.gravatar.com/avatar/98bbac18a8c6ff78732516b70a357c58?s=80"><meta property="article:published_time" content="2022-08-22T21:50:30+02:00"><meta property="article:modified_time" content="2022-08-26T18:12:48+02:00"><base href=https://pawelweselak.com/posts/lima-vm/><title>Lima quick-start · Pragmatic Programming</title><link rel=canonical href=https://pawelweselak.com/posts/lima-vm/><link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel=stylesheet><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.13.0/css/all.css integrity=sha384-Bfad6CLCknfcloXFOyFnlgtENryhrpZCe29RTifKEixXQZ38WheV+i/6YWSzkz3V crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin=anonymous><link rel=stylesheet href=https://pawelweselak.com/css/coder.min.a4f332213a21ce8eb521670c614470c58923aaaf385e2a73982c31dd7642decb.css integrity="sha256-pPMyITohzo61IWcMYURwxYkjqq84XipzmCwx3XZC3ss=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://pawelweselak.com/css/coder-dark.min.83a2010dac9f59f943b3004cd6c4f230507ad036da635d3621401d42ec4e2835.css integrity="sha256-g6IBDayfWflDswBM1sTyMFB60DbaY102IUAdQuxOKDU=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=https://pawelweselak.com/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://pawelweselak.com/images/favicon-16x16.png sizes=16x16><meta name=generator content="Hugo 0.69.0"></head><body class=colorscheme-auto><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://pawelweselak.com/>Pragmatic Programming</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fas fa-bars"></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://pawelweselak.com/about/>About</a></li><li class=navigation-item><a class=navigation-link href=https://pawelweselak.com/projects/>Projects</a></li><li class=navigation-item><a class=navigation-link href=https://pawelweselak.com/posts/>Posts</a></li><li class=navigation-item><a class=navigation-link href=https://pawelweselak.com/categories/>Categories</a></li><li class=navigation-item><a class=navigation-link href=https://pawelweselak.com/tags/>Tags</a></li><li class=navigation-item><a class=navigation-link href=https://pawelweselak.com/search/>Search</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title>Lima quick-start</h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fas fa-calendar"></i><time datetime=2022-08-22T21:50:30+02:00>August 22, 2022</time></span>
<span class=reading-time><i class="fas fa-clock"></i>4-minute read</span></div><div class=categories><i class="fas fa-folder"></i><a href=https://pawelweselak.com/categories/devops/>devops</a>
<span class=separator>•</span>
<a href=https://pawelweselak.com/categories/tools/>tools</a></div><div class=tags><i class="fas fa-tag"></i><a href=https://pawelweselak.com/tags/lima/>lima</a>
<span class=separator>•</span>
<a href=https://pawelweselak.com/tags/docker/>docker</a>
<span class=separator>•</span>
<a href=https://pawelweselak.com/tags/network/>network</a>
<span class=separator>•</span>
<a href=https://pawelweselak.com/tags/dns/>dns</a>
<span class=separator>•</span>
<a href=https://pawelweselak.com/tags/containerisation/>containerisation</a></div></div></header><div><h2 id=motivation>Motivation</h2><p>Since January 31st, 2022 Docker Desktop cannot be commercially used for free in bigger organisations.
Until now several tools may fill the gap, if you, my Dear Developer, forced to uninstall Docker Desktop.
Docker Desktop is a complete, self-sufficient package ready to use tools including UI to run containers.
To replace Docker Desktop you will need to build a custom setup comprising set of tools.
Installing and configuring different tools may be complex and time-consuming.
On the other hand, you have more control and flexibility.</p><p>In this article I will describe simplistic approach to run Lima-VM on macOS combined with standard Docker CLI,
which is still free to use for everyone.
I will cover also configuration changes I applied to make Lima working for me. I would like to emphasize
network setup for DNS and cross-arch support for new Apple Silicon M1 processors.</p><h2 id=what-is-lima>What is Lima?</h2><p>Lima stands for &ldquo;Linux machines&rdquo;. It was created to run Linux virtual machines as guests on macOS hosts.
Although, Lima can be used on Linux hosts as well.</p><p>It is built on top QEMU, quick emulator.
It makes possible running multiple operating systems on the same physical machine.</p><h2 id=installing-lima-and-starting-vm>Installing Lima and Starting VM</h2><p>To install Lima on macOS it is enough to handover it to brew.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>brew install lima
</code></pre></div><p>Another way is to install Lima from sources, but in 99% cases you don&rsquo;t gonna need it.
I do not cover installation from sources in this article.</p><p>After installation, you may want to check the version of Lima.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>lima --version
</code></pre></div><p>Now it is time to start first Virtual Machine with Lima.
There are preconfigured templates (configurations) you can use out of the box.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>limactl start template://docker
</code></pre></div><p>Here <code>docker</code> is a template name.</p><p>To check available templates, run</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>limactl start --list-templates
</code></pre></div><p>You can prepare your own configuration in local yaml file or tweak existing examples.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>cp /usr/local/share/doc/lima/examples/docker.yaml .
<span class=c1># do some changes in docker.yaml here</span>
limactl start ./docker.yaml
</code></pre></div><p>You can also start lima passing <code>name</code> parameter.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>limactl start --name<span class=o>=</span>default template://docker
</code></pre></div><p>By default, the name of the VM instance is the same as template name or name of local file without <code>.yaml</code> extensions. [TBC]</p><p>To stop and delete instance, refer to its name.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>limactl stop docker
limactl delete docker
</code></pre></div><p>If the instance name is <code>default</code> you can omit name in the command.
Or you can set <code>LIMA_INSTANCE</code> env variable and <code>limactl</code> commands will refer to instance name defined in the variable.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>export</span> <span class=nv>LIMA_INSTANCE</span><span class=o>=</span><span class=s2>&#34;docker&#34;</span>
</code></pre></div><h2 id=configuration>Configuration</h2><p>I won&rsquo;t cover all possible config options here. Rather than that I will describe two aspects which I had to change,
to make Lima usable on my end.</p><p>After creating VM, a folder is created under <code>~/.lima</code> named the same as VM.
You can find <code>lima.yaml</code> there, your VM configuration file.</p><h3 id=cross-arch>Cross-arch</h3><p>You may have new, shiny mac with Apple Silicon M1 microchip.
Despite the fact, it may be a good idea to switch back to x86 64-bit architecture.
It will save you troubles with running containers not available for new Apple architecture.</p><p>Just put one line in your <code>lima.yaml</code> and restart a machine.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=k>arch</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;x86_64&#34;</span><span class=w>
</span></code></pre></div><h3 id=network>Network</h3><p>By default, guest OS works in so called user-mode network, and generally it has limitations.
There are many issues regarding network support in Lima&rsquo;s GitHub. Not all of them are already closed.</p><p>Personally, I had a problem with domain names resolution. I am connected to corporate network. Most often I use VPN.
In my case DNS hosts were incorrectly passed from host to guest OS.</p><p>Fortunately, there is a way to enforce DNS IPs in guest. I had to add following config to <code>lima.yaml</code>.</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=k>dns</span><span class=p>:</span><span class=w>
</span><span class=w></span>- <span class=m>10.</span>a.b.c<span class=w>
</span><span class=w></span>- <span class=m>10.</span>x.y.z<span class=w>
</span><span class=w></span>- <span class=m>1.1.1.1</span><span class=w>
</span><span class=w></span>- <span class=m>1.0.0.1</span><span class=w>
</span><span class=w></span><span class=k>useHostResolver</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></code></pre></div><p>First two addresses indicate corporate/VPN network DNS hosts. Next pair is primary and secondary servers of Cloudflare.
They can be replaced by any other publicly accessible DNS servers.
They are used as a fallback when you outside corporate/VPN network.</p><p>Don&rsquo;t forget to change <code>useHostResolver</code> to false. Otherwise, VM won&rsquo;t start.</p><h2 id=running-a-container>Running a container</h2><p>Install docker CLI if not done already.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>brew install docker docker-compose docker-credential-helper
</code></pre></div><p>The last one is a tool to use mac keychain for storing container registry passwords after doing <code>docker login ...</code>.</p><p>After starting Lima VM from docker template, message is printed with info how to run a container with docker CLI.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>docker context create lima-docker --docker <span class=s2>&#34;host=unix://&lt;DIRECTORY&gt;/sock/docker.sock&#34;</span>
docker context use lima-docker
docker run hello-world
</code></pre></div><h2 id=next-steps>Next steps</h2><p>To unlock full potential of Lima, you probably what to use it with Containerd.
Containerd has certain advanced features when comes to running containers.
Moreover, if you&rsquo;re working in cross-arch environment,
having Containerd enabled is more performant than solution presented in the article.</p><h2 id=sources>Sources</h2><ul><li><a href=https://github.com/lima-vm>https://github.com/lima-vm</a></li><li><a href=https://www.qemu.org/>https://www.qemu.org/</a></li><li><a href=https://wiki.qemu.org/Documentation/Networking>https://wiki.qemu.org/Documentation/Networking</a></li></ul></div><footer></footer></article></section></div><footer class=footer><section class=container><p>Everything should be as simple as possible, but not simplier.</p>©
2010 -
2022
Paweł Weselak
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.
[<a href=https://github.com/frenchu/pragmatic-programming/tree/a01a939ac84ad181e7101f69a0e0c8342b185324>a01a939</a>]</section></footer></main></body></html>