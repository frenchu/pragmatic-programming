<!doctype html><html lang=en><head><title>LTE router on Raspberry Pi · Pragmatic Programming</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Paweł Weselak"><meta name=description content="Configuring cellurar networking with Waveshare GSM hat"><meta name=keywords content="Paweł Weselak,personal blog,senior java developer,senior software engineer"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://pawelweselak.com/images/telephone.jpg"><meta name=twitter:title content="LTE router on Raspberry Pi"><meta name=twitter:description content="Configuring cellurar networking with Waveshare GSM hat"><meta property="og:title" content="LTE router on Raspberry Pi"><meta property="og:description" content="Configuring cellurar networking with Waveshare GSM hat"><meta property="og:type" content="article"><meta property="og:url" content="https://pawelweselak.com/posts/rpi-lte-router/"><meta property="og:image" content="https://pawelweselak.com/images/telephone.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-11-04T00:00:00+00:00"><meta property="article:modified_time" content="2023-11-05T13:42:46+01:00"><link rel=canonical href=https://pawelweselak.com/posts/rpi-lte-router/><link rel=preload href="https://pawelweselak.com/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=https://pawelweselak.com/css/coder.min.135e22c97ff685fe983fc60048e309ced8f00d8d38f536aa67dba8a13a03dfa4.css integrity="sha256-E14iyX/2hf6YP8YASOMJztjwDY049TaqZ9uooToD36Q=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://pawelweselak.com/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=https://pawelweselak.com/images/favicon.svg sizes=any><link rel=icon type=image/png href=https://pawelweselak.com/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://pawelweselak.com/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=https://pawelweselak.com/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=https://pawelweselak.com/images/apple-touch-icon.png><link rel=manifest href=https://pawelweselak.com/site.webmanifest><link rel=mask-icon href=https://pawelweselak.com/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://pawelweselak.com/>Pragmatic Programming</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://pawelweselak.com/about/>About</a></li><li class=navigation-item><a class=navigation-link href=https://pawelweselak.com/projects/>Projects</a></li><li class=navigation-item><a class=navigation-link href=https://pawelweselak.com/posts/>Posts</a></li><li class=navigation-item><a class=navigation-link href=https://pawelweselak.com/categories/>Categories</a></li><li class=navigation-item><a class=navigation-link href=https://pawelweselak.com/tags/>Tags</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://pawelweselak.com/posts/rpi-lte-router/>LTE router on Raspberry Pi</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2023-11-04T00:00:00Z>November 4, 2023</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
5-minute read</span></div><div class=categories><i class="fa fa-folder" aria-hidden=true></i>
<a href=https://pawelweselak.com/categories/iot/>IoT</a></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=https://pawelweselak.com/tags/hardware/>hardware</a></span>
<span class=separator>•</span>
<span class=tag><a href=https://pawelweselak.com/tags/networking/>networking</a></span></div></div></header><div class=post-content><p>I finally managed to find some free time to take a look on Waveshare SIM7600E-H 4G HAT.
I bought it to extend capabilities of my Raspberry Pi 4 model B single board computer.</p><p>Here, I want to give a short tutorial how to setup LTE WAN networking in Raspberry Pi SBC.
I will describe how to make use of the network tooling in new Raspberry Pi OS which is based on recent Debian Bookworm release.
At the end, I will present configuration of WAN connection sharing with other hosts in a LAN.</p><p>I struggled a bit with LTE modem configuration, but finally I managed to come up with the setup in three simple, fast steps.</p><figure><img src=https://pawelweselak.com/images/telephone.jpg alt="Convoluted networking - telephone pole with number of wires"><figcaption><p>Cellular networking</p></figcaption></figure><h2 id=hardware-assembly>Hardware assembly
<a class=heading-link href=#hardware-assembly><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>I didn&rsquo;t install Waveshare SIM7600E-H as a regular hat, but I used USB cable solely to connect the device with RPi board.
SIM7600E-H 4G HAT is supplied together with two USB cables. One of them is quite long, so you can position hat in some distance from RPi board.
Thanks to that you can put hat with antenna in convient place for better signal reception.</p><p>Ofcourse before start using the device, we also need to insert SIM card from your mobile operator
and connect provided antenna to the &ldquo;main&rdquo; socket.</p><p>Quite important thing is to set UART JMP jumper in position A.</p><figure><img src=https://pawelweselak.com/images/waveshare-sim7600e-h.jpg alt="Raspberry Pi with connected Waveshare SIM7600E-H 4G HAT"><figcaption><p>Assembled GSM kit</p></figcaption></figure><h2 id=os-installation>OS installation
<a class=heading-link href=#os-installation><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>I chose official <a href=https://www.raspberrypi.com/software/ class=external-link target=_blank rel=noopener>Raspberry Pi OS imager</a> to install operation system on the board.
Since I am using RPi as a server I picked Lite OS version. When I purchased my board only 32-bit Raspbian OS was available.
Now I can fully leverage on 64-bit arm architecture of RPi 4B with Raspberry Pi OS.
At the beginning, I installed Ununtu arm64 which was released before 64-bit version of Raspberry Pi OS.</p><p>Before writing OS image to a memory card, I edited the settings to set a hostname and enable SSH server with public key login.
I had some difficulties with ED25519 key, so I stick to RSA. I haven&rsquo;t have chance yet to explore the issue further.</p><h2 id=installing-required-packages>Installing required packages
<a class=heading-link href=#installing-required-packages><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>First, let&rsquo;s install neccessary tooling.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo apt install libqmi-utils udhcpc
</span></span></code></pre></div><p>QMI is a communication protocol for modems built on top of Qualcomm chips. Modem Manager can handle <code>libqmi</code> library calls for you.
Another tool - <code>udhcpc</code> is required to obtain WAN IP address from mobile operator via DHCP.</p><p>For seeting up a cellurar networking NetworkManager and ModemManager services will also be required in our setup.
Although, they should be installed and enabled by default in the newest RPi OS. You can verify it with:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo systemctl status NetworkManager
</span></span><span class=line><span class=cl>sudo systemctl status ModemManager
</span></span></code></pre></div><h2 id=configuring-modem-connection-and-routing>Configuring modem connection and routing
<a class=heading-link href=#configuring-modem-connection-and-routing><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Debian Bookworm is equiped with several interesting console tools for network setup:</p><ul><li><code>nmtui</code> - NetworkManager terminal user interface</li><li><code>nmcli</code> - NetworkManager command line interface</li><li><code>mmcli</code> - ModemManager command line tool</li></ul><p>Let&rsquo;s start network configuration with cellurar networking. In order to establish mobile connection check the commands below.</p><p>List available modems:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>mmcli -L
</span></span></code></pre></div><p>Print details of the first modem:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>mmcli -m <span class=m>0</span>
</span></span></code></pre></div><p>Unlock SIM card with PIN number (replace xxxx with your PIN):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo mmcli -m <span class=m>0</span> -i <span class=m>0</span> --pin<span class=o>=</span>xxxx
</span></span></code></pre></div><p>Enable modem:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo mmcli -m <span class=m>0</span> -e
</span></span></code></pre></div><p>Start a new connection (please adhere you settings like APN name, IP type or authentication mode - check that with your mobile operator):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo mmcli -m <span class=m>0</span> --simple-connect<span class=o>=</span><span class=s2>&#34;apn=internet,ip-type=ipv4,allowed-auth=pap&#34;</span>
</span></span></code></pre></div><p>At this stage, the cellurar connection should be up. You can verify it with commands:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>ip a
</span></span><span class=line><span class=cl>ping -I wwan0 8.8.8.8
</span></span></code></pre></div><p>As a next step we probably want to add a gsm connection profile in Network Manager:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo nmcli c add <span class=nb>type</span> gsm ifname <span class=s1>&#39;*&#39;</span> con-name <span class=s1>&#39;t-mobile&#39;</span> apn internet pin xxxx connection.autoconnect yes
</span></span></code></pre></div><p>Setting <code>connection.autoconnect</code> property will make the connection to start at the system boot.</p><p>The last, optional step is to enable routing, i.e. share the mobile connection with other hosts in the cable network.
It is quite simple. Just run <code>sudo nmtui</code> and find in termianl UI option to edit your wired connection. Switch mode from &lsquo;auto&rsquo; to &lsquo;shared&rsquo;.</p><p>By default &lsquo;shared&rsquo; mode will set static ip <code>10.72.0.1/24</code> for <code>eth0</code> interface. It will also start DHCP server on that interface,
enable NAT and IP masquarade. You can change default IP by setting desired IP in <code>address</code> field.</p><h2 id=trobleshooting>Trobleshooting
<a class=heading-link href=#trobleshooting><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>You may find below commands useful in diagnosing connectivity problems.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>lsusb
</span></span><span class=line><span class=cl>lsusb -t
</span></span><span class=line><span class=cl>ip a
</span></span><span class=line><span class=cl>ping -I 8.8.8.8
</span></span><span class=line><span class=cl>mmcli -L
</span></span><span class=line><span class=cl>mmcli -m <span class=m>0</span>
</span></span><span class=line><span class=cl>mmcli -m <span class=m>0</span> -b <span class=m>0</span>
</span></span><span class=line><span class=cl>mmcli -m <span class=m>0</span> -b <span class=m>1</span>
</span></span></code></pre></div><p>For troubleshooting your modem you may want to install <code>minicom</code> AT terminal app.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo apt install minicom
</span></span></code></pre></div><p>Then you can connect to modem TTY port and issue AT commands (device name may be different):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo minicom /dev/ttyUSB2
</span></span></code></pre></div><p>Some handy AT commands can be found on <a href=https://www.waveshare.com/wiki/SIM7600E-H_4G_HAT#FAQ class=external-link target=_blank rel=noopener>Waveshare FAQ</a>.
You can also find there a description of different modem operating modes.</p><p>In my case I need to switch modem to RNDIS (9001) mode and change default APN name:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>AT+CUSBPIDSWITCH=9001,1,1
</span></span><span class=line><span class=cl>AT+CGDCONT=1,&#34;IP&#34;,&#34;internet&#34;,&#34;0.0.0.0&#34;,0,0
</span></span></code></pre></div><p>You can also use qmi directly and bypass ModemManager. Example diagnostic commands are:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo qmicli -d /dev/cdc-wdm0 -w
</span></span><span class=line><span class=cl>sudo qmicli -d /dev/cdc-wdm0 --dms-get-operating-mode
</span></span><span class=line><span class=cl>sudo qmicli -d /dev/cdc-wdm0 --nas-get-signal-strength
</span></span><span class=line><span class=cl>sudo qmicli -d /dev/cdc-wdm0 --nas-get-home-network
</span></span></code></pre></div><h2 id=web-resources>Web resources
<a class=heading-link href=#web-resources><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ul><li><a href=https://www.waveshare.com/wiki/SIM7600E-H_4G_HAT class=external-link target=_blank rel=noopener>Waveshare SIM7600E-H 4G HAT wiki page</a></li><li><a href=https://www.raspberrypi.com/documentation/computers/getting-started.html#install-using-imager class=external-link target=_blank rel=noopener>Raspberry Pi OS imager docs</a></li><li><a href=https://www.wevolver.com/article/add-cellular-connectivity-to-your-raspberry-pi class=external-link target=_blank rel=noopener>Post on the other blog re cellurar connectivity in RPi</a></li><li><a href=https://fedoramagazine.org/internet-connection-sharing-networkmanager/ class=external-link target=_blank rel=noopener>NetworkManager shared connection configuration</a></li><li><a href=https://docs.fedoraproject.org/en-US/fedora-server/administration/dnsmasq/ class=external-link target=_blank rel=noopener>DNSmasq configuration</a></li><li><a href=https://mikrokontroler.pl/2020/05/05/nakladka-na-raspberry-pi-z-modemem-4g-waveshare-sim7600e-4g-hat/ class=external-link target=_blank rel=noopener>Waveshare SIM7600 overview (in polish)</a></li><li><a href=https://www.embeddedpi.com/documentation/3g-4g-modems/raspberry-pi-sierra-wireless-mc7455-modem-raw-ip-qmi-interface-setup class=external-link target=_blank rel=noopener>Manual QMI setup</a></li><li><a href=https://www.simcom.com/product/SIM7600X.html class=external-link target=_blank rel=noopener>SIM7600X chip details</a></li></ul></div><footer><section class=see-also></section><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//pragmatic-programming.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}(),document.addEventListener("themeChanged",function(){document.readyState=="complete"&&DISQUS.reset({reload:!0,config:disqus_config})})</script></footer></article></section></div><footer class=footer><section class=container>©
2010 -
2023
Paweł Weselak
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.
[<a href=https://github.com/frenchu/pragmatic-programming/tree/c66ce4046195bf2e86128b54cfe55cf65078a34e target=_blank rel=noopener>c66ce40</a>]</section></footer></main><script src=https://pawelweselak.com/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>