<!doctype html><html lang=en><head><title>Conquer Issues with Pasta in Rootless Docker · Pragmatic Programming</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Paweł Weselak"><meta name=description content="Docker Rootless Networking with Pasta Network Driver"><meta name=keywords content="Paweł Weselak,personal blog,senior java developer,senior software engineer"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://pawelweselak.com/images/shipping.jpg"><meta name=twitter:title content="Conquer Issues with Pasta in Rootless Docker"><meta name=twitter:description content="Docker Rootless Networking with Pasta Network Driver"><meta property="og:title" content="Conquer Issues with Pasta in Rootless Docker"><meta property="og:description" content="Docker Rootless Networking with Pasta Network Driver"><meta property="og:type" content="article"><meta property="og:url" content="https://pawelweselak.com/posts/docker-rootless-pasta-networking/"><meta property="og:image" content="https://pawelweselak.com/images/shipping.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-02-02T00:00:00+00:00"><meta property="article:modified_time" content="2025-02-02T17:15:44+01:00"><link rel=canonical href=https://pawelweselak.com/posts/docker-rootless-pasta-networking/><link rel=preload href="https://pawelweselak.com/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=https://pawelweselak.com/css/coder.min.135e22c97ff685fe983fc60048e309ced8f00d8d38f536aa67dba8a13a03dfa4.css integrity="sha256-E14iyX/2hf6YP8YASOMJztjwDY049TaqZ9uooToD36Q=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://pawelweselak.com/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=https://pawelweselak.com/images/favicon.svg sizes=any><link rel=icon type=image/png href=https://pawelweselak.com/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://pawelweselak.com/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=https://pawelweselak.com/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=https://pawelweselak.com/images/apple-touch-icon.png><link rel=manifest href=https://pawelweselak.com/site.webmanifest><link rel=mask-icon href=https://pawelweselak.com/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://pawelweselak.com/>Pragmatic Programming</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://pawelweselak.com/about/>About</a></li><li class=navigation-item><a class=navigation-link href=https://pawelweselak.com/projects/>Projects</a></li><li class=navigation-item><a class=navigation-link href=https://pawelweselak.com/posts/>Posts</a></li><li class=navigation-item><a class=navigation-link href=https://pawelweselak.com/categories/>Categories</a></li><li class=navigation-item><a class=navigation-link href=https://pawelweselak.com/tags/>Tags</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://pawelweselak.com/posts/docker-rootless-pasta-networking/>Conquer Issues with Pasta in Rootless Docker</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2025-02-02T00:00:00Z>February 2, 2025</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
3-minute read</span></div><div class=categories><i class="fa fa-folder" aria-hidden=true></i>
<a href=https://pawelweselak.com/categories/tools/>tools</a>
<span class=separator>•</span>
<a href=https://pawelweselak.com/categories/security/>security</a>
<span class=separator>•</span>
<a href=https://pawelweselak.com/categories/networking/>networking</a></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=https://pawelweselak.com/tags/containers/>containers</a></span>
<span class=separator>•</span>
<span class=tag><a href=https://pawelweselak.com/tags/docker/>docker</a></span>
<span class=separator>•</span>
<span class=tag><a href=https://pawelweselak.com/tags/rootless/>rootless</a></span>
<span class=separator>•</span>
<span class=tag><a href=https://pawelweselak.com/tags/pasta/>pasta</a></span></div></div></header><div class=post-content><p>In front of geopolitical tensions and increasing risk of cyber-attacks, I am making efforts to
gain more and more hard skills in the area of cyber security.</p><p>Some time ago I switched from running docker daemon as root to so called <a href=https://github.com/rootless-containers/rootlesskit class=external-link target=_blank rel=noopener>rootless containers</a>. It allows to run docker daemon as regular user with reduced privileges. The whole process is very well documented in the <a href=https://docs.docker.com/engine/security/rootless/ class=external-link target=_blank rel=noopener>docker documentation</a>. However there are some limitations and trade-offs.</p><p>One important aspect which still needs improvement is networking, especially in terms of network performance. There are several network drivers for rootless docker which help to mitigate the problem. I decided to test <a href=https://passt.top/ class=external-link target=_blank rel=noopener>pasta</a> driver.</p><p>Even if Pasta is still in experimental phase, it works pretty well. However in my case I need to solve one issue. In this article I want to describe a problem and present the solution I came up.</p><figure><img src=https://pawelweselak.com/images/shipping.jpg alt="Shipping - cargo ship full of containers in a dock"><figcaption><p>Docker containers</p></figcaption></figure><h2 id=problem-statement>Problem Statement
<a class=heading-link href=#problem-statement><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>What I observed, after setting up rootless docker in my Debian and Ubuntu systems, is problem during system boot. The docker daemon, configured for a user, didn&rsquo;t start.</p><p>When I checked the service status with command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>systemctl --user status docker.service
</span></span></code></pre></div><p>I saw this error message:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>docker.service: Start request repeated too quickly.
</span></span><span class=line><span class=cl>docker.service: Failed with result &#39;exit-code&#39;.
</span></span></code></pre></div><p>After digging in the system logs with:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>journalctl --user -xeu docker.service
</span></span></code></pre></div><p>I&rsquo;ve noticed that <code>pasta</code> gave up:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Jan 17 07:50:06 jupiter pasta[1223]: No routable interface for IPv4: IPv4 is disabled
</span></span><span class=line><span class=cl>Jan 17 07:50:06 jupiter pasta[1223]: External interface not usable
</span></span></code></pre></div><p>It made me think that the network was not ready when pasta was starting.</p><h2 id=failed-attempts>Failed Attempts
<a class=heading-link href=#failed-attempts><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>My first idea was to make sure that network is ready and only than trigger <code>docker.service</code>. I read about <code>network-online.target</code> on <a href=https://systemd.io/NETWORK_ONLINE/ class=external-link target=_blank rel=noopener>systemd.io</a> and it was promising.</p><p>Unfortunately, setting dependency between <code>network-online.target</code> and <code>docker.service</code> didn&rsquo;t help. Apparently this approach is only valid for system services and don&rsquo;t work with user services.</p><h2 id=working-solution>Working Solution
<a class=heading-link href=#working-solution><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>So what I did instead? I went back to the original error message telling me that &lsquo;Start request repeated too quickly&rsquo;. It seemed like <code>systemd</code> was trying to restart docker several times, but it eventually gave up.</p><p>The answer was to just restart <code>docker.service</code>, but not &rsquo;too quickly&rsquo;. I&rsquo;ve changed the service definition under <code>~/.config/systemd/user/docker.service</code>. I added following statements under <code>[Unit]</code> section:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[Unit]
</span></span><span class=line><span class=cl>StartLimitBurst=3
</span></span><span class=line><span class=cl>StartLimitIntervalSec=60
</span></span></code></pre></div><p>And extended the time between restart attempts:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[Service]
</span></span><span class=line><span class=cl>TimeoutSec=0
</span></span><span class=line><span class=cl>RestartSec=10
</span></span></code></pre></div><p>Also I removed unnecessary settings from <code>[Service]</code> section (they should be in the <code>[Unit]</code> section according to the <a href=https://www.man7.org/linux/man-pages/man5/systemd.unit.5.html class=external-link target=_blank rel=noopener>manual</a>):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[Service]
</span></span><span class=line><span class=cl>StartLimitBurst=3
</span></span><span class=line><span class=cl>StartLimitInterval=60
</span></span></code></pre></div><h2 id=alternatives>Alternatives
<a class=heading-link href=#alternatives><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Another solution might be use of <code>ExecStartPre</code> option inside <code>docker.service</code> definition. For example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[Service]
</span></span><span class=line><span class=cl>ExecStartPre=sh -c &#39;until ping -c 1 pawelweselak.com; do sleep 1; done&#39;
</span></span></code></pre></div><p>Although, I haven&rsquo;t tested it yet. I&rsquo;m OK with restarting docker once during boot to mitigate the problem.</p><h2 id=bonus>Bonus
<a class=heading-link href=#bonus><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>I forgot to mention that I had one more issue with pasta. It was specific to Debian distro. In this case <code>pasta</code> was blocked by <code>apparmor</code>, because of missing <code>apparmor</code> profile specific for <code>pasta</code> executable.</p><p>To solve that I changed symlinks to hardlinks:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>cd</span> /usr/bin
</span></span><span class=line><span class=cl>sudo rm pasta pasta.avx2
</span></span><span class=line><span class=cl>sudo ln passt pasta
</span></span><span class=line><span class=cl>sudo ln passt.avx2 pasta.avx2
</span></span></code></pre></div><p>And restarted <code>apparmor</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo aa-teardown
</span></span><span class=line><span class=cl>sudo systemctl restart apparmor
</span></span></code></pre></div><h2 id=additional-resources>Additional resources
<a class=heading-link href=#additional-resources><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ul><li><a href=https://docs.docker.com/engine/security/rootless/#networking-errors class=external-link target=_blank rel=noopener>List of available network drivers for Docker</a></li><li><a href=https://github.com/rootless-containers/rootlesskit/blob/master/docs/network.md class=external-link target=_blank rel=noopener>RootlessKit Network Drivers documentation</a></li><li><a href=https://github.com/rootless-containers/bypass4netns class=external-link target=_blank rel=noopener><code>bypass4netns</code> driver</a></li></ul></div><footer><section class=see-also></section><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//pragmatic-programming.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}(),document.addEventListener("themeChanged",function(){document.readyState=="complete"&&DISQUS.reset({reload:!0,config:disqus_config})})</script></footer></article></section></div><footer class=footer><section class=container>©
2010 -
2025
Paweł Weselak
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.
[<a href=https://github.com/frenchu/pragmatic-programming/tree/18966a8251d9a48af20bce2fa04f87b0588a663b target=_blank rel=noopener>18966a8</a>]</section></footer></main><script src=https://pawelweselak.com/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>