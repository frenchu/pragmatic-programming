<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="PaweÅ‚ Weselak"><meta name=description content="Blog of PaweÅ‚ Weselak pragmatyczne programowanie"><meta name=keywords content="PaweÅ‚ Weselak,personal blog,senior java developer,senior software engineer"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://pawelweselak.com/images/sailing-ship.jpg"><meta name=twitter:title content="Kotlintest adventures"><meta name=twitter:description content="Common kotlintest pitfalls and how to deal with them"><meta property="og:title" content="Kotlintest adventures"><meta property="og:description" content="Common kotlintest pitfalls and how to deal with them"><meta property="og:type" content="article"><meta property="og:url" content="https://pawelweselak.com/posts/kotlintest-adventures/"><meta property="og:image" content="https://pawelweselak.com/images/sailing-ship.jpg"><meta property="article:published_time" content="2020-03-14T00:00:00+00:00"><meta property="article:modified_time" content="2020-04-20T19:08:54+02:00"><base href=https://pawelweselak.com/posts/kotlintest-adventures/><title>Kotlintest adventures Â· Pragmatic Programming</title><link rel=canonical href=https://pawelweselak.com/posts/kotlintest-adventures/><link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel=stylesheet><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.13.0/css/all.css integrity=sha384-Bfad6CLCknfcloXFOyFnlgtENryhrpZCe29RTifKEixXQZ38WheV+i/6YWSzkz3V crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin=anonymous><link rel=stylesheet href=https://pawelweselak.com/css/coder.min.a4f332213a21ce8eb521670c614470c58923aaaf385e2a73982c31dd7642decb.css integrity="sha256-pPMyITohzo61IWcMYURwxYkjqq84XipzmCwx3XZC3ss=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://pawelweselak.com/css/coder-dark.min.83a2010dac9f59f943b3004cd6c4f230507ad036da635d3621401d42ec4e2835.css integrity="sha256-g6IBDayfWflDswBM1sTyMFB60DbaY102IUAdQuxOKDU=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=https://pawelweselak.com/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://pawelweselak.com/images/favicon-16x16.png sizes=16x16><meta name=generator content="Hugo 0.69.0"></head><body class=colorscheme-auto><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://pawelweselak.com/>Pragmatic Programming</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fas fa-bars"></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://pawelweselak.com/about/>About</a></li><li class=navigation-item><a class=navigation-link href=https://pawelweselak.com/projects/>Projects</a></li><li class=navigation-item><a class=navigation-link href=https://pawelweselak.com/posts/>Posts</a></li><li class=navigation-item><a class=navigation-link href=https://pawelweselak.com/categories/>Categories</a></li><li class=navigation-item><a class=navigation-link href=https://pawelweselak.com/tags/>Tags</a></li><li class=navigation-item><a class=navigation-link href=https://pawelweselak.com/search/>Search</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title>Kotlintest adventures</h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fas fa-calendar"></i><time datetime=2020-03-14T22:45:41+02:00>March 14, 2020</time></span>
<span class=reading-time><i class="fas fa-clock"></i>7-minute read</span></div><div class=categories><i class="fas fa-folder"></i><a href=https://pawelweselak.com/categories/backend/>backend</a>
<span class=separator>â€¢</span>
<a href=https://pawelweselak.com/categories/qa/>qa</a></div><div class=tags><i class="fas fa-tag"></i><a href=https://pawelweselak.com/tags/kotlintest/>kotlintest</a>
<span class=separator>â€¢</span>
<a href=https://pawelweselak.com/tags/kotlin/>kotlin</a>
<span class=separator>â€¢</span>
<a href=https://pawelweselak.com/tags/jvm/>jvm</a></div></div></header><div><p><em>Common pitfalls and how to deal with them</em></p><figure><img src=https://pawelweselak.com/images/pirates-only.jpg alt="Kotlintest mutiny - pirate skull inviting only true pirates"><figcaption><p>Photo by Mateusz Dach on Pexels</p></figcaption></figure><h2 id=intro>Intro</h2><p>Our team currently started cruise to develop the next version of â€˜the API&rsquo; and a new set of services emerged during that journey. We have a free hand to sail to the open waters of technologies ocean, so we can choose the best fit for our project. Our ship wharfed to an island named Kotlin language. Very quickly we discovered Kotlintest library on this land. When fighting the battle of writing test cases to our production code, we had a mutiny incited by Kotlintest. In this article, I want to describe the course of the rebellion and how our brave team suppressed it.</p><h2 id=why-kotlintest-at-all>Why Kotlintest at all?</h2><p>In terms of writing tests in Kotlin you have several test libraries to choose. The most common are Spek, JUnit5 (preferably with some assertion library like AssertJ or HamKrest) and of course Kotlintest. As Dear Reader probably already anticipated, in our project we decided to use Kotlintest. The authors of the library are inspired by the test library for Scala - Scalatest. Our team promotes functional programming, so do Kotlintest team. The library has many useful features like different styles of writing test specifications, soft assertions or data-driven testing. It is also quite popular in the community, actively developed and well supported.</p><h2 id=minor-but-persistent>Minor but persistent</h2><p>There are a few annoying things about Kotlintest. First of all, integration with IntelliJ - the IDE which we use on a daily basis, is not so good. It is impossible to execute a test case of one&rsquo;s choice from test specification. I tried the official IntelliJ plugin with <del>no avail</del>. Thanks to my project manager I realized that the plugin to run things smoothly requires some additional configuration. And it wasn&rsquo;t straightforward for me. To set it up, first install a plugin named Kotlintest. After that, if you are using Gradle in IntelliJ preferences under <code>Build, Execution, Deployment > Build Tools > Gradle</code> select <code>Run tests using: IntelliJ IDEA</code>. Then upon running a test, you can choose to run it with the Kotlintest plugin. If it doesn&rsquo;t work try to use Restart/Invalidate cache option.</p><p>Before the moment I started using Kotlintest plugin, I had found in the documentation mention about prefixing test case with &ldquo;f:". It should do the trick as it is done in popular JavaScript libraries. Prefix &ldquo;f:&rdquo; means focused here. Unfortunately this tip doesn&rsquo;t work well. Neither standard IntelliJ runner nor Gradle will execute any tests if I try to focus any test case. IntelliJ informs that there are no tests received.</p><script type=application/javascript src="https://gist.github.com/frenchu/ed723987dabb9c52b4af80cdb8be6074.js?file=FocusedStringSpec.kt"></script><p>Surprisingly bang tests with exclamation mark &ldquo;!&rdquo; works. It excludes the test case from running. So if want to focus some test case I just exclude all the others. ðŸ˜œ</p><script type=application/javascript src="https://gist.github.com/frenchu/ed723987dabb9c52b4af80cdb8be6074.js?file=BangStringSpec.kt"></script><p>Again this feature works perfectly fine with the Kotlintest plugin. This can be solved also by adding <a href=https://plugins.gradle.org/plugin/io.kotlintest>Kotlintest Gradle plugin</a> to your project. Please compare the <a href=https://github.com/kotest/kotest/issues/605>GitHub issue</a>.</p><h2 id=duplicated-test-name>Duplicated test name</h2><p>There are more issues that will lead to a situation where tests should be executed, but they don&rsquo;t. It is a serious problem when a test certainly should fail. We observed that behavior when the name of the test case method was duplicated by mistake. Any test case of the specification sadly didn&rsquo;t run. It caused the whole build was green, but actually it didn&rsquo;t. The problem was masked and not easy to spot.</p><script type=application/javascript src="https://gist.github.com/frenchu/ed723987dabb9c52b4af80cdb8be6074.js?file=DuplicatedStringSpec.kt"></script><p>The root cause of the issue was the tiny dependency hell we had in the project. ðŸ˜‰ To be more precise, Kotlin depends on arrow-core-data in version 0.9.0 while our project uses arrow 0.10.x. It leads to the replacement of the arrow-core-data version on which Kotlintest is dependent.</p><script type=application/javascript src="https://gist.github.com/frenchu/ed723987dabb9c52b4af80cdb8be6074.js?file=build.gradle.kts"></script><h2 id=when-spring-eventually-comes>When Spring eventually comes&mldr;</h2><p>Similar issue we could encounter while running integration tests with Spring. When the creation of the Spring context is failed then none of the test cases is executed from the test. The same as in the previous issue this leads to falsely green build and it is hard to notice. The cause of the issue was the same as in the <a href=#duplicated-test-name>Duplicated test name</a>.</p><p>One digression on testing with Spring. We don&rsquo;t like much autowiring lateinit var variables approach. Mutable state is not something we want to have in our functional code even if it is in tests. Hopefully Kotlintest allows us to wiring through constructor of test spec. To enable that Spring project extension needs to be added to the project. This approach has some drawbacks although. The project listeners/extensions are executed before test listeners. So if you have any test setup that the Spring context creation depends on, you cannot put it in the test listeners. In that case we use Spring test context configuration with post construct and post destroy lifecycle methods. In the last resort, one can go back to <code>autowired</code> <code>lateinit</code> vars.</p><h2 id=strange-behavior>Strange behavior</h2><p>Talking about test listeners there is one thing worth mentioning. If you take advantage of BehaviorSpec, most likely you want to run test listener methods before and after <em>whole</em> given/when/then test case. Use <code>isTopLevel</code> method, otherwise <code>afterTestCase</code> and <code>beforeTestCase</code> methods will execute not only on <code>given</code>, but also on <code>when</code> and <code>then</code> blocks.</p><script type=application/javascript src="https://gist.github.com/frenchu/ed723987dabb9c52b4af80cdb8be6074.js?file=IsTopLevelSpec.kt"></script><p>Another strange thing is the way how test results are reported in IntelliJ after running Gradle test task. Only &ldquo;Then&rdquo; names are listed on the report. So if you have several &ldquo;Thens&rdquo; labeled the same way in your Test specification, it is not easy to distinguish them. The problem can be solved with Kotlintest plugin. Running the tests using this plugin will show the nested structure of given/when/then on the report.</p><p>One can complain about the tree-like structure of BehaviorSpec. Indeed, it is a definite advantage of the library. Thanks to that Kotlin compiler itself can check the right order of clauses. In JUnit you can put labels or comments, but they don&rsquo;t have any meaning. While in Spock, a test library for Groovy, checking of labels order is added by the library.</p><h2 id=are-you-still-hiding-something-from-me-kotlintest>Are you still hiding something from me, Kotlintest?</h2><p>Please be careful when you are going to use AssertSoftly. Normally all assertions in the assert softly block will be executed even if the first one fails. Dear reader can meet yet another concealed troubles there. Assert softly works well with Kotlintest matchers. But if you want to combine other testing tools like reactor-test for example, they most likely throw some kind of AssertionException when assertion fails. It will cause that assert softly block will be interrupted. If you don&rsquo;t always follow TDD completely you may not notice this &ldquo;feature&rdquo; in the first place.</p><script type=application/javascript src="https://gist.github.com/frenchu/ed723987dabb9c52b4af80cdb8be6074.js?file=AssertSoftlySpec.kt"></script><p>To avoid that you probably want to implement your custom matchers. In your matcher you can catch AssertionException in the overridden test method. Then return boolean indicating success or failure of the assertion.</p><script type=application/javascript src="https://gist.github.com/frenchu/ed723987dabb9c52b4af80cdb8be6074.js?file=AssertSoftlyWithCustomMatcherSpec.kt"></script><p>Another annoying thing is related to <code>.config</code> method usage. In behavioral tests, it is defined for <code>then</code> but not for <code>Then</code> method. I like starting test level names with capital letter since <code>when</code> is a reserved keyword in Kotlin. In order to compile your code, you need to put it in backticks: <code>when</code>. So instead of <code>given</code>, <code>when</code>, <code>then</code> one can use <code>Given</code>, <code>When</code>, <code>Then</code>. Except you want to add config to the test. In this case you have to use <code>Given</code>, <code>When</code>, <code>then</code> which looks silly.</p><script type=application/javascript src="https://gist.github.com/frenchu/ed723987dabb9c52b4af80cdb8be6074.js?file=ConfigOnThenSpec.kt"></script><h2 id=summary>Summary</h2><p>Is our journey with Kotlintest over? I hope not. Probably we will discover even more issues, but despite its peculiarities Kotlintest is a promising library. The development is very active, and the releases are coming quite frequently. We optimistically see the future of the library. In the upcoming release library is changing the name from Kotlintest to Kotest. Beta versions for the 4.0.0 release are already available. In the next article I will describe the migration steps needed. And also I will check if the above issues have been fixed.</p><p>How about you? I strongly encourage you to check the library on your own. Maybe you have some other solutions to share? Feel free to post your comment below the article.</p><p>A complete project with code samples is available on my <a href=https://github.com/frenchu/kotlintest-pitfalls>GitHub</a>.</p><figure><img src=https://pawelweselak.com/images/sailing-ship.jpg alt="Kotlintest journey - sailing ship reaching a bay"><figcaption><p>Photo by Pixabay on Pexels</p></figcaption></figure></div><footer><section class=see-also><h3>See also in Kotlintest adoption</h3><nav><ul><li><a href=https://pawelweselak.com/posts/kotest-migration-guide/>Kotest 4.0 migration guide</a></li></ul></nav></section></footer></article></section></div><footer class=footer><section class=container><p>Everything should be as simple as possible, but not simplier.</p>Â©
2010 -
2020
PaweÅ‚ Weselak
Â·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.
[<a href=https://github.com/frenchu/pragmatic-programming/tree/e99d64a4bc80faa19a7ad8c35bf245859879fe44>e99d64a</a>]</section></footer></main></body></html>