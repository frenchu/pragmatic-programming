<!doctype html><html lang=en><head><title>VPN with nmcli on Raspberry Pi · Pragmatic Programming</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Paweł Weselak"><meta name=description content="Configuring Raspberry Pi networking with VPN"><meta name=keywords content="Paweł Weselak,personal blog,senior java developer,senior software engineer"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://pawelweselak.com/images/vpn.jpg"><meta name=twitter:title content="VPN with nmcli on Raspberry Pi"><meta name=twitter:description content="Configuring Raspberry Pi networking with VPN"><meta property="og:title" content="VPN with nmcli on Raspberry Pi"><meta property="og:description" content="Configuring Raspberry Pi networking with VPN"><meta property="og:type" content="article"><meta property="og:url" content="https://pawelweselak.com/posts/rpi-lte-router-vpn/"><meta property="og:image" content="https://pawelweselak.com/images/vpn.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-11-17T00:00:00+00:00"><meta property="article:modified_time" content="2024-07-16T23:46:57+02:00"><meta property="og:see_also" content="https://pawelweselak.com/posts/rpi-lte-router/"><link rel=canonical href=https://pawelweselak.com/posts/rpi-lte-router-vpn/><link rel=preload href="https://pawelweselak.com/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=https://pawelweselak.com/css/coder.min.135e22c97ff685fe983fc60048e309ced8f00d8d38f536aa67dba8a13a03dfa4.css integrity="sha256-E14iyX/2hf6YP8YASOMJztjwDY049TaqZ9uooToD36Q=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://pawelweselak.com/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=https://pawelweselak.com/images/favicon.svg sizes=any><link rel=icon type=image/png href=https://pawelweselak.com/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://pawelweselak.com/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=https://pawelweselak.com/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=https://pawelweselak.com/images/apple-touch-icon.png><link rel=manifest href=https://pawelweselak.com/site.webmanifest><link rel=mask-icon href=https://pawelweselak.com/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://pawelweselak.com/>Pragmatic Programming</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://pawelweselak.com/about/>About</a></li><li class=navigation-item><a class=navigation-link href=https://pawelweselak.com/projects/>Projects</a></li><li class=navigation-item><a class=navigation-link href=https://pawelweselak.com/posts/>Posts</a></li><li class=navigation-item><a class=navigation-link href=https://pawelweselak.com/categories/>Categories</a></li><li class=navigation-item><a class=navigation-link href=https://pawelweselak.com/tags/>Tags</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://pawelweselak.com/posts/rpi-lte-router-vpn/>VPN with nmcli on Raspberry Pi</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2023-11-17T00:00:00Z>November 17, 2023</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
3-minute read</span></div><div class=categories><i class="fa fa-folder" aria-hidden=true></i>
<a href=https://pawelweselak.com/categories/hardware/>hardware</a></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=https://pawelweselak.com/tags/iot/>IoT</a></span>
<span class=separator>•</span>
<span class=tag><a href=https://pawelweselak.com/tags/networking/>networking</a></span>
<span class=separator>•</span>
<span class=tag><a href=https://pawelweselak.com/tags/vpn/>VPN</a></span>
<span class=separator>•</span>
<span class=tag><a href=https://pawelweselak.com/tags/admin/>admin</a></span></div></div></header><div class=post-content><p>In my <a href=../rpi-lte-router>previous article</a> I described how to setup cellurar networking on RaspberryPi with GSM hat.
The problem is most often you will not get public IP address from your operator when using cellurar network.
It means difficulties to access to your RaspberryPi and it&rsquo;s network from remote location.
On the other hand the device is not exposed to the Internet threats.</p><p>In my case I want to use my RPi to control survilance system installed in a holiday cottage.
And I need to access RPi from my home in a downtown. To achive that I&rsquo;m using OpenVPN tunnel over public internet.
VPN gives me both secure and easy access to the router.</p><p>In this article I will show how to enable VPN connection over cellurar connection configured before.
Again, I will give a recipe for NetworkManager and nmcli setup.
These tools will manage openvpn client connection for us.</p><figure><img src=https://pawelweselak.com/images/vpn.jpg alt="Shield as a part of armor"><figcaption><p>Virtual Private Networking</p></figcaption></figure><h2 id=ovpn-configuration-file>OVPN configuration file
<a class=heading-link href=#ovpn-configuration-file><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>A prerequisite to configure a VPN connection is to obtain a OpenVPN configuration file.
Typicaly you can get one from your OpenVPN server.</p><p>In my case I have Asus home router with built-in OpenVPN server. In this article I skip description how to
configure OpenVPN server and generate PKI certificates. It depends on your software or equipment.</p><p>I will assume that OVPN config file contains server CA and client certificates together with password protected private key.</p><h2 id=importing-openvpn-configuration>Importing OpenVPN configuration
<a class=heading-link href=#importing-openvpn-configuration><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Make sure you have required OS packages:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo apt install network-manager-openvpn
</span></span></code></pre></div><p>Import your OpenVPN configuration file to NetworkManager:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo nmcli connection import <span class=nb>type</span> openvpn file rpi.ovpn
</span></span></code></pre></div><p>Example output:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Connection &#39;rpi&#39; (24c3311d-c49f-4392-931d-7bd58cf8b4d3) successfully added.
</span></span></code></pre></div><p>Please note down the ID of your new &lsquo;rpi&rsquo; vpn connection. We will use that in the next step.</p><h2 id=additional-setup>Additional setup
<a class=heading-link href=#additional-setup><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>After importing connection, we can tweak several settings.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo nmcli connection modify rpi +vpn.user-name rpi
</span></span><span class=line><span class=cl>sudo nmcli connection modify rpi +vpn.password-flags <span class=m>0</span>
</span></span><span class=line><span class=cl>sudo nmcli connection modify rpi +vpn.cert-pass-flags <span class=m>0</span>
</span></span><span class=line><span class=cl>sudo nmcli connection modify rpi +vpn.secrets <span class=nv>password</span><span class=o>=</span><span class=s1>&#39;VPN_USER_PASSWORD&#39;</span>
</span></span><span class=line><span class=cl>sudo nmcli connection modify rpi +vpn.secrets cert-pass<span class=o>=</span><span class=s1>&#39;PRIVATE_KEY_PASSWORD&#39;</span>
</span></span><span class=line><span class=cl>sudo nmcli connection modify t-mobile +connection.secondaries 24c3311d-c49f-4392-931d-7bd58cf8b4d3
</span></span></code></pre></div><p><code>user-name</code> param is self explenatory, although <code>password-flags</code> and <code>cert-pass-flags</code> require some comments.
Normally, in a desktop environment NetworkManager will read passwords from password manager like Gnome keyring.
In automated, non-interactive setups it may make more sense to store passwords in NetworkManager connection config.
To accomplish that we set the flags to <code>0</code>. If the above config params doesn&rsquo;t work, you can edit connection config file directly.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudoedit /etc/NetworkManager/system-connections/rpi.nmconnection
</span></span></code></pre></div><p>and put these entries</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[vpn]
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>password-flags=0
</span></span><span class=line><span class=cl>cert-pass-flags=0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[vpn-secrets]
</span></span><span class=line><span class=cl>password=VPN_USER_PASSWORD
</span></span><span class=line><span class=cl>cert-pass=PRIVATE_KEY_PASSWORD
</span></span></code></pre></div><p>Restart NetworkManager to apply new settings</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo systemctl restart NetworkManager
</span></span></code></pre></div><p>Command with <code>connection.secondaries</code> will set VPN connection as a secondary connection for a GSM connection, which means VPN client connection
will be started whenever the GSM connectionn is up.</p><h2 id=web-resources>Web resources
<a class=heading-link href=#web-resources><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><ul><li><a href=https://www.linux.org/docs/man1/nmcli.html class=external-link target=_blank rel=noopener>nmcli man page</a></li><li><a href=https://openvpn.net/community-resources/reference-manual-for-openvpn-2-4/ class=external-link target=_blank rel=noopener>OpenVPN Community docs</a></li></ul></div><footer><section class=see-also><h3 id=see-also-in-raspberrypi>See also in RaspberryPi
<a class=heading-link href=#see-also-in-raspberrypi><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><nav><ul><li><a href=https://pawelweselak.com/posts/rpi-lte-router/>LTE router on Raspberry Pi</a></li></ul></nav></section><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//pragmatic-programming.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}(),document.addEventListener("themeChanged",function(){document.readyState=="complete"&&DISQUS.reset({reload:!0,config:disqus_config})})</script></footer></article></section></div><footer class=footer><section class=container>©
2010 -
2024
Paweł Weselak
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.
[<a href=https://github.com/frenchu/pragmatic-programming/tree/2df914c6b32693d4fee81e72f102e83e84b4260e target=_blank rel=noopener>2df914c</a>]</section></footer></main><script src=https://pawelweselak.com/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>